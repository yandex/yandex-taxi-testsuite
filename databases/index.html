
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>Database support &#8212; yandex-taxi-testsuite 0.1.9 documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css" />
    <link rel="stylesheet" type="text/css" href="../_static/pygments_pytest.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/sphinx_highlight.js"></script>
    <link rel="index" title="Index" href="../genindex/" />
    <link rel="search" title="Search" href="../search/" />
    <link rel="next" title="Other plugins" href="../other_plugins/" />
    <link rel="prev" title="Testpoint" href="../testpoint/" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="database-support">
<h1>Database support<a class="headerlink" href="#database-support" title="Permalink to this heading">¶</a></h1>
<nav class="contents local" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#common-database-marks" id="id39">Common database marks</a></p>
<ul>
<li><p><a class="reference internal" href="#pytest-mark-nofilldb" id="id40">pytest.mark.nofilldb</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#mongo" id="id41">Mongo</a></p>
<ul>
<li><p><a class="reference internal" href="#fixtures" id="id42">Fixtures</a></p></li>
<li><p><a class="reference internal" href="#marks" id="id43">Marks</a></p></li>
<li><p><a class="reference internal" href="#classes" id="id44">Classes</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#postgresql" id="id45">PostgreSQL</a></p>
<ul>
<li><p><a class="reference internal" href="#customize-port" id="id46">Customize port</a></p></li>
<li><p><a class="reference internal" href="#use-external-instance" id="id47">Use external instance</a></p></li>
<li><p><a class="reference internal" href="#reuse-database-between-simultaneous-sessions" id="id48">Reuse database between simultaneous sessions</a></p></li>
<li><p><a class="reference internal" href="#example-integration" id="id49">Example integration</a></p></li>
<li><p><a class="reference internal" href="#database-access-example" id="id50">Database access example</a></p></li>
<li><p><a class="reference internal" href="#functions" id="id51">Functions</a></p></li>
<li><p><a class="reference internal" href="#id9" id="id52">Fixtures</a></p></li>
<li><p><a class="reference internal" href="#id10" id="id53">Marks</a></p></li>
<li><p><a class="reference internal" href="#id11" id="id54">Classes</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#mysql" id="id55">MySQL</a></p>
<ul>
<li><p><a class="reference internal" href="#id12" id="id56">Customize port</a></p></li>
<li><p><a class="reference internal" href="#id13" id="id57">Use external instance</a></p></li>
<li><p><a class="reference internal" href="#id14" id="id58">Example integration</a></p></li>
<li><p><a class="reference internal" href="#id15" id="id59">Database access example</a></p></li>
<li><p><a class="reference internal" href="#id17" id="id60">Functions</a></p></li>
<li><p><a class="reference internal" href="#id19" id="id61">Fixtures</a></p></li>
<li><p><a class="reference internal" href="#id21" id="id62">Marks</a></p></li>
<li><p><a class="reference internal" href="#id22" id="id63">Classes</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#redis" id="id64">Redis</a></p></li>
<li><p><a class="reference internal" href="#clickhouse" id="id65">ClickHouse</a></p>
<ul>
<li><p><a class="reference internal" href="#clickhouse-installation" id="id66">ClickHouse installation</a></p></li>
<li><p><a class="reference internal" href="#customize-ports" id="id67">Customize ports</a></p></li>
<li><p><a class="reference internal" href="#id23" id="id68">Use external instance</a></p></li>
<li><p><a class="reference internal" href="#id24" id="id69">Example integration</a></p></li>
<li><p><a class="reference internal" href="#id25" id="id70">Database access example</a></p></li>
<li><p><a class="reference internal" href="#id27" id="id71">Functions</a></p></li>
<li><p><a class="reference internal" href="#id29" id="id72">Fixtures</a></p></li>
<li><p><a class="reference internal" href="#id31" id="id73">Marks</a></p></li>
<li><p><a class="reference internal" href="#id32" id="id74">Classes</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#rabbitmq" id="id75">RabbitMQ</a></p>
<ul>
<li><p><a class="reference internal" href="#rabbitmq-installation" id="id76">RabbitMQ installation</a></p></li>
<li><p><a class="reference internal" href="#id33" id="id77">Customize ports</a></p></li>
<li><p><a class="reference internal" href="#id34" id="id78">Use external instance</a></p></li>
<li><p><a class="reference internal" href="#usage-example" id="id79">Usage example</a></p></li>
<li><p><a class="reference internal" href="#id36" id="id80">Fixtures</a></p></li>
<li><p><a class="reference internal" href="#id38" id="id81">Classes</a></p></li>
</ul>
</li>
</ul>
</nav>
<p>Database plugins can start and stop database process.
You can configure it to use existing database.</p>
<p>Testsuite clears database and applies data fixtures before each test ensure
database in known state.</p>
<p>Data fixtures are loaded via staatic files, see <a class="reference internal" href="../staticfiles/#staticfiles"><span class="std std-ref">Working with static files</span></a>.</p>
<section id="common-database-marks">
<h2><a class="toc-backref" href="#id39" role="doc-backlink">Common database marks</a><a class="headerlink" href="#common-database-marks" title="Permalink to this heading">¶</a></h2>
<section id="pytest-mark-nofilldb">
<h3><a class="toc-backref" href="#id40" role="doc-backlink">pytest.mark.nofilldb</a><a class="headerlink" href="#pytest-mark-nofilldb" title="Permalink to this heading">¶</a></h3>
<p>Disables database loading.</p>
<dl class="py function">
<dt class="sig sig-object py" id="pytest.mark.nofilldb">
<span class="sig-prename descclassname"><span class="pre">pytest.mark.</span></span><span class="sig-name descname"><span class="pre">nofilldb</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#pytest.mark.nofilldb" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

</section>
</section>
<section id="mongo">
<h2><a class="toc-backref" href="#id41" role="doc-backlink">Mongo</a><a class="headerlink" href="#mongo" title="Permalink to this heading">¶</a></h2>
<p>In ordrer to enable mongo support you have to add
<code class="docutils literal notranslate"><span class="pre">testsuite.database.mongo.pytest_plugin</span></code> to <code class="docutils literal notranslate"><span class="pre">pytest_plugins</span></code> list in your
<code class="docutils literal notranslate"><span class="pre">conftest.py</span></code> file and configure mongodb collections.</p>
<p>By default testsuite starts mongodb sharded cluster. In this case <a class="reference external" href="https://www.mongodb.com/">mongodb</a>
installation is required.</p>
<p>Testsuite may start mongodb with custom ports, if following environment
variables are specified:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">TESTSUITE_MONGO_CONFIG_SERVER_PORT</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">TESTSUITE_MONGOS_PORT</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">TESTSUITE_MONGO_SHARD_PORT</span></code></p></li>
</ul>
<p>You can force it to use your own mongo installation with command-line option
<code class="docutils literal notranslate"><span class="pre">--mongo=mongodb://host:port/</span></code>.</p>
<p>Mongodb plugins re-fills the whole database with data on each test.
It looks for data fixture static files using <code class="docutils literal notranslate"><span class="pre">db_collection_name.json</span></code>
pattern. If no file is found collection is empty.</p>
<p>Currently mongo plugin uses synchronous <a class="reference external" href="https://api.mongodb.com/python/current/">pymongo</a> driver.</p>
<p>Example integration:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">pytest_plugins</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;testsuite.pytest_plugin&#39;</span><span class="p">,</span>
    <span class="s1">&#39;testsuite.databases.mongo.pytest_plugin&#39;</span><span class="p">,</span>
<span class="p">]</span>

<span class="n">MONGO_COLLECTIONS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;example_collection&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;settings&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;collection&#39;</span><span class="p">:</span> <span class="s1">&#39;example_collection&#39;</span><span class="p">,</span>
            <span class="s1">&#39;connection&#39;</span><span class="p">:</span> <span class="s1">&#39;example&#39;</span><span class="p">,</span>
            <span class="s1">&#39;database&#39;</span><span class="p">:</span> <span class="s1">&#39;example_db&#39;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s1">&#39;indexes&#39;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="p">},</span>
<span class="p">}</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s1">&#39;session&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">mongodb_settings</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">MONGO_COLLECTIONS</span>
</pre></div>
</div>
<section id="fixtures">
<h3><a class="toc-backref" href="#id42" role="doc-backlink">Fixtures</a><a class="headerlink" href="#fixtures" title="Permalink to this heading">¶</a></h3>
<section id="id1">
<h4>mongodb<a class="headerlink" href="#id1" title="Permalink to this heading">¶</a></h4>
<dl class="py function">
<dt class="sig sig-object py" id="testsuite.databases.mongo.pytest_plugin.mongodb">
<span class="sig-prename descclassname"><span class="pre">testsuite.databases.mongo.pytest_plugin.</span></span><span class="sig-name descname"><span class="pre">mongodb</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="../_modules/testsuite/databases/mongo/pytest_plugin/#mongodb"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#testsuite.databases.mongo.pytest_plugin.mongodb" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns <code class="xref py py-class docutils literal notranslate"><span class="pre">CollectionWrapper</span></code> instance. Collection can be accessed
by name, e.g.:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_foo</span><span class="p">(</span><span class="n">mongodb</span><span class="p">):</span>
    <span class="n">doc</span> <span class="o">=</span> <span class="n">mongodb</span><span class="o">.</span><span class="n">collection_name</span><span class="o">.</span><span class="n">find_one</span><span class="p">({</span><span class="s1">&#39;_id&#39;</span><span class="p">:</span> <span class="mi">123</span><span class="p">})</span>
    <span class="k">assert</span> <span class="n">doc</span> <span class="o">==</span> <span class="p">{</span><span class="o">...</span><span class="p">}</span>
</pre></div>
</div>
<p><code class="xref py py-class docutils literal notranslate"><span class="pre">pymongo.collection.Collection</span></code> instance is returned.</p>
</dd></dl>

</section>
<section id="mongo-connection-info">
<h4>mongo_connection_info<a class="headerlink" href="#mongo-connection-info" title="Permalink to this heading">¶</a></h4>
<dl class="py function">
<dt class="sig sig-object py" id="testsuite.databases.mongo.pytest_plugin.mongo_connection_info">
<span class="sig-prename descclassname"><span class="pre">testsuite.databases.mongo.pytest_plugin.</span></span><span class="sig-name descname"><span class="pre">mongo_connection_info</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="../_modules/testsuite/databases/mongo/pytest_plugin/#mongo_connection_info"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#testsuite.databases.mongo.pytest_plugin.mongo_connection_info" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns an instance of class
<a class="reference internal" href="#testsuite.databases.mongo.connection.ConnectionInfo" title="testsuite.databases.mongo.connection.ConnectionInfo"><code class="xref py py-class docutils literal notranslate"><span class="pre">testsuite.databases.mongo.connection.ConnectionInfo</span></code></a></p>
</dd></dl>

</section>
<section id="mongo-host">
<h4>mongo_host<a class="headerlink" href="#mongo-host" title="Permalink to this heading">¶</a></h4>
<dl class="py function">
<dt class="sig sig-object py" id="testsuite.databases.mongo.pytest_plugin.mongo_host">
<span class="sig-prename descclassname"><span class="pre">testsuite.databases.mongo.pytest_plugin.</span></span><span class="sig-name descname"><span class="pre">mongo_host</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="../_modules/testsuite/databases/mongo/pytest_plugin/#mongo_host"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#testsuite.databases.mongo.pytest_plugin.mongo_host" title="Permalink to this definition">¶</a></dt>
<dd><p>Deprecated, use <code class="docutils literal notranslate"><span class="pre">mongo_connection_info</span></code> instead
returns: string with mongo connection uri</p>
<p>This fixture is obsolete. Use <code class="docutils literal notranslate"><span class="pre">mongo_connection_info</span></code> fixture instead.</p>
<p>Returns mongodb connection string, e.g.:
<code class="docutils literal notranslate"><span class="pre">mongodb://localhost:27119/?retryWrites=false</span></code></p>
<p><code class="docutils literal notranslate"><span class="pre">retryWrites</span></code> parameter can be changed through <code class="docutils literal notranslate"><span class="pre">pytest.ini</span></code> via
<code class="docutils literal notranslate"><span class="pre">mongo-retry-writes</span></code> boolean setting. Default value is <code class="docutils literal notranslate"><span class="pre">false</span></code> which is
required since mongodb version 4.2 and pymongo version 3.9.</p>
</dd></dl>

</section>
</section>
<section id="marks">
<h3><a class="toc-backref" href="#id43" role="doc-backlink">Marks</a><a class="headerlink" href="#marks" title="Permalink to this heading">¶</a></h3>
<section id="pytest-mark-filldb">
<h4>pytest.mark.filldb<a class="headerlink" href="#pytest-mark-filldb" title="Permalink to this heading">¶</a></h4>
<p>Specify custom per-test collection data file prefix.</p>
<dl class="py function">
<dt class="sig sig-object py" id="testsuite.databases.mongo.pytest_plugin.pytest.mark.filldb">
<span class="sig-prename descclassname"><span class="pre">pytest.mark.</span></span><span class="sig-name descname"><span class="pre">filldb</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="o"><span class="pre">**</span></span><span class="n"><span class="pre">suffixes</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#testsuite.databases.mongo.pytest_plugin.pytest.mark.filldb" title="Permalink to this definition">¶</a></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>suffixes</strong> – collection suffixes map, e.g.
<code class="docutils literal notranslate"><span class="pre">{'collection':</span> <span class="pre">'suffix',</span> <span class="pre">...}</span></code></p>
</dd>
</dl>
</dd></dl>

<p>I
In the following example plugin will look for filename
<code class="docutils literal notranslate"><span class="pre">db_collection_name_foo.json</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">filldb</span><span class="p">(</span><span class="n">collection_name</span><span class="o">=</span><span class="s1">&#39;foo&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_foo</span><span class="p">(</span><span class="o">...</span><span class="p">):</span>
</pre></div>
</div>
</section>
</section>
<section id="classes">
<h3><a class="toc-backref" href="#id44" role="doc-backlink">Classes</a><a class="headerlink" href="#classes" title="Permalink to this heading">¶</a></h3>
<dl class="py class">
<dt class="sig sig-object py" id="testsuite.databases.mongo.connection.ConnectionInfo">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">testsuite.databases.mongo.connection.</span></span><span class="sig-name descname"><span class="pre">ConnectionInfo</span></span><a class="reference internal" href="../_modules/testsuite/databases/mongo/connection/#ConnectionInfo"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#testsuite.databases.mongo.connection.ConnectionInfo" title="Permalink to this definition">¶</a></dt>
<dd><p>Mongodb connection uri parameters</p>
<dl class="py method">
<dt class="sig sig-object py" id="testsuite.databases.mongo.connection.ConnectionInfo.get_uri">
<span class="sig-name descname"><span class="pre">get_uri</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">dbname</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/typing.html#typing.Optional" title="(in Python v3.11)"><span class="pre">Optional</span></a><span class="p"><span class="pre">[</span></span><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.11)"><span class="pre">str</span></a><span class="p"><span class="pre">]</span></span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">retry_writes</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/typing.html#typing.Optional" title="(in Python v3.11)"><span class="pre">Optional</span></a><span class="p"><span class="pre">[</span></span><a class="reference external" href="https://docs.python.org/3/library/functions.html#bool" title="(in Python v3.11)"><span class="pre">bool</span></a><span class="p"><span class="pre">]</span></span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.11)"><span class="pre">str</span></a></span></span><a class="reference internal" href="../_modules/testsuite/databases/mongo/connection/#ConnectionInfo.get_uri"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#testsuite.databases.mongo.connection.ConnectionInfo.get_uri" title="Permalink to this definition">¶</a></dt>
<dd><p>Get mongodb connection uri</p>
</dd></dl>

</dd></dl>

</section>
</section>
<section id="postgresql">
<h2><a class="toc-backref" href="#id45" role="doc-backlink">PostgreSQL</a><a class="headerlink" href="#postgresql" title="Permalink to this heading">¶</a></h2>
<p>In order to enable postgres support you have to add
<code class="docutils literal notranslate"><span class="pre">testsuite.database.pgsql_plugin</span></code> to <code class="docutils literal notranslate"><span class="pre">pytest_plugins</span></code> list in your
<code class="docutils literal notranslate"><span class="pre">conftest.py</span></code> file and configure postgresql schemas location.</p>
<p>By default testsuite starts <a class="reference external" href="https://www.postgresql.org/">PostgreSQL</a> service. In this case
PostgreSQL installation is required.</p>
<p>Currently pgsql plugin uses synchronous <a class="reference external" href="https://pypi.org/project/psycopg2/">psycopg2</a> driver.</p>
<p>Pgsql plugin creates database schema once. And then populates database
with data fixtures on each test. It looks for database fixtures by the
following names:</p>
<ul class="simple">
<li><p>file <code class="docutils literal notranslate"><span class="pre">pg_DBNAME.sql</span></code></p></li>
<li><p>directory <code class="docutils literal notranslate"><span class="pre">pg_DBNAME/</span></code></p></li>
</ul>
<section id="customize-port">
<h3><a class="toc-backref" href="#id46" role="doc-backlink">Customize port</a><a class="headerlink" href="#customize-port" title="Permalink to this heading">¶</a></h3>
<p>Testsuite may start postgres with custom port, if <code class="docutils literal notranslate"><span class="pre">TESTSUITE_POSTGRESQL_PORT</span></code>
environment variable is specified</p>
</section>
<section id="use-external-instance">
<h3><a class="toc-backref" href="#id47" role="doc-backlink">Use external instance</a><a class="headerlink" href="#use-external-instance" title="Permalink to this heading">¶</a></h3>
<p>You can force it to use your own postgres installation with command-line option
<code class="docutils literal notranslate"><span class="pre">--postgresql=postgresql://db-postgresql/</span></code>.</p>
</section>
<section id="reuse-database-between-simultaneous-sessions">
<h3><a class="toc-backref" href="#id48" role="doc-backlink">Reuse database between simultaneous sessions</a><a class="headerlink" href="#reuse-database-between-simultaneous-sessions" title="Permalink to this heading">¶</a></h3>
<p>In general, testsuite does not support running simultaneous sessions, except
when testsuite is started with <code class="docutils literal notranslate"><span class="pre">--postgresql-keep-existing-db</span></code> or
<code class="docutils literal notranslate"><span class="pre">--service-runner-mode</span></code> flag.</p>
<p>In service runner mode testsuite starts the service and waits indefinitely
so that developer can attach to running service with debugger.</p>
<p>If one session in service runner mode creates database and applies schemas,
then the next one will skip applying schemas on initialization, unless schemas
were modified since then.</p>
</section>
<section id="example-integration">
<h3><a class="toc-backref" href="#id49" role="doc-backlink">Example integration</a><a class="headerlink" href="#example-integration" title="Permalink to this heading">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">testsuite.databases.pgsql</span> <span class="kn">import</span> <span class="n">discover</span>

<span class="n">pytest_plugins</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;testsuite.pytest_plugin&#39;</span><span class="p">,</span>
    <span class="s1">&#39;testsuite.databases.pgsql.pytest_plugin&#39;</span><span class="p">,</span>
<span class="p">]</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s1">&#39;session&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">pgsql_local</span><span class="p">(</span><span class="n">pgsql_local_create</span><span class="p">):</span>
    <span class="n">tests_dir</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span>
    <span class="n">sqldata_path</span> <span class="o">=</span> <span class="n">tests_dir</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;../schemas/postgresql&#39;</span><span class="p">)</span>
    <span class="n">databases</span> <span class="o">=</span> <span class="n">discover</span><span class="o">.</span><span class="n">find_schemas</span><span class="p">(</span><span class="s1">&#39;service_name&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">sqldata_path</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">pgsql_local_create</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">databases</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
</pre></div>
</div>
</section>
<section id="database-access-example">
<h3><a class="toc-backref" href="#id50" role="doc-backlink">Database access example</a><a class="headerlink" href="#database-access-example" title="Permalink to this heading">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_read_from_database</span><span class="p">(</span><span class="n">pgsql</span><span class="p">):</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">pgsql</span><span class="p">[</span><span class="s1">&#39;chat_messages&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="s1">&#39;SELECT username, text FROM messages WHERE id = </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],),</span>
    <span class="p">)</span>
    <span class="n">record</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">record</span> <span class="o">==</span> <span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="functions">
<h3><a class="toc-backref" href="#id51" role="doc-backlink">Functions</a><a class="headerlink" href="#functions" title="Permalink to this heading">¶</a></h3>
<section id="find-schemas">
<h4>find_schemas<a class="headerlink" href="#find-schemas" title="Permalink to this heading">¶</a></h4>
<dl class="py function">
<dt class="sig sig-object py" id="testsuite.databases.pgsql.discover.find_schemas">
<span class="sig-prename descclassname"><span class="pre">testsuite.databases.pgsql.discover.</span></span><span class="sig-name descname"><span class="pre">find_schemas</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">service_name</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/typing.html#typing.Optional" title="(in Python v3.11)"><span class="pre">Optional</span></a><span class="p"><span class="pre">[</span></span><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.11)"><span class="pre">str</span></a><span class="p"><span class="pre">]</span></span></span></em>, <em class="sig-param"><span class="n"><span class="pre">schema_dirs</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/typing.html#typing.List" title="(in Python v3.11)"><span class="pre">List</span></a><span class="p"><span class="pre">[</span></span><a class="reference external" href="https://docs.python.org/3/library/pathlib.html#pathlib.Path" title="(in Python v3.11)"><span class="pre">Path</span></a><span class="p"><span class="pre">]</span></span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><a class="reference external" href="https://docs.python.org/3/library/typing.html#typing.Dict" title="(in Python v3.11)"><span class="pre">Dict</span></a><span class="p"><span class="pre">[</span></span><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.11)"><span class="pre">str</span></a><span class="p"><span class="pre">,</span></span><span class="w"> </span><span class="pre">PgShardedDatabase</span><span class="p"><span class="pre">]</span></span></span></span><a class="reference internal" href="../_modules/testsuite/databases/pgsql/discover/#find_schemas"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#testsuite.databases.pgsql.discover.find_schemas" title="Permalink to this definition">¶</a></dt>
<dd><dl class="simple">
<dt>Read database schemas from directories <code class="docutils literal notranslate"><span class="pre">schema_dirs</span></code>. ::</dt><dd><dl class="simple">
<dt><a href="#id3"><span class="problematic" id="id4">|</span></a>- schema_path/</dt><dd><p><a href="#id5"><span class="problematic" id="id6">|</span></a>- database1.sql
<a href="#id7"><span class="problematic" id="id8">|</span></a>- database2.sql</p>
</dd>
</dl>
</dd>
</dl>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>service_name</strong> – service name used as prefix for database name if not
empty, e.g. “servicename_dbname”.</p></li>
<li><p><strong>schema_dirs</strong> – list of pathes to scan for schemas</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p><code class="xref py py-class docutils literal notranslate"><span class="pre">Dict[str,</span> <span class="pre">PgShardedDatabase]</span></code> where key is
database name as stored in <code class="xref py py-attr docutils literal notranslate"><span class="pre">PgShard.dbname</span></code></p>
</dd>
</dl>
</dd></dl>

</section>
</section>
<section id="id9">
<h3><a class="toc-backref" href="#id52" role="doc-backlink">Fixtures</a><a class="headerlink" href="#id9" title="Permalink to this heading">¶</a></h3>
<section id="pgsql">
<h4>pgsql<a class="headerlink" href="#pgsql" title="Permalink to this heading">¶</a></h4>
<dl class="py function">
<dt class="sig sig-object py" id="testsuite.databases.pgsql.pytest_plugin.pgsql">
<span class="sig-prename descclassname"><span class="pre">testsuite.databases.pgsql.pytest_plugin.</span></span><span class="sig-name descname"><span class="pre">pgsql</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="../_modules/testsuite/databases/pgsql/pytest_plugin/#pgsql"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#testsuite.databases.pgsql.pytest_plugin.pgsql" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns str to
<a class="reference internal" href="#testsuite.databases.pgsql.control.PgDatabaseWrapper" title="testsuite.databases.pgsql.control.PgDatabaseWrapper"><code class="xref py py-class docutils literal notranslate"><span class="pre">testsuite.databases.pgsql.control.PgDatabaseWrapper</span></code></a> dictionary</p>
<p>Example usage:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_pg</span><span class="p">(</span><span class="n">pgsql</span><span class="p">):</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">pgsql</span><span class="p">[</span><span class="s1">&#39;example_db&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SELECT ... FROM ...WHERE ...&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">list</span><span class="p">(</span><span class="n">cusror</span><span class="p">)</span> <span class="o">==</span> <span class="p">[</span><span class="o">...</span><span class="p">]</span>
</pre></div>
</div>
</dd></dl>

</section>
<section id="pgsql-cleanup-exclude-tables">
<h4>pgsql_cleanup_exclude_tables<a class="headerlink" href="#pgsql-cleanup-exclude-tables" title="Permalink to this heading">¶</a></h4>
<dl class="py function">
<dt class="sig sig-object py" id="testsuite.databases.pgsql.pytest_plugin.pgsql_cleanup_exclude_tables">
<span class="sig-prename descclassname"><span class="pre">testsuite.databases.pgsql.pytest_plugin.</span></span><span class="sig-name descname"><span class="pre">pgsql_cleanup_exclude_tables</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="../_modules/testsuite/databases/pgsql/pytest_plugin/#pgsql_cleanup_exclude_tables"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#testsuite.databases.pgsql.pytest_plugin.pgsql_cleanup_exclude_tables" title="Permalink to this definition">¶</a></dt>
<dd><p>Redefine this fixture when you don’t need to clean some tables.
For example postgis create table with spatial reference systems. To use postgis you need to
add this fixture with spatial_ref_sys table.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s1">&#39;session&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">pgsql_cleanup_exclude_tables</span><span class="p">():</span>
    <span class="k">return</span> <span class="nb">frozenset</span><span class="p">({</span><span class="s1">&#39;public.spatial_ref_sys&#39;</span><span class="p">})</span>
</pre></div>
</div>
</dd></dl>

</section>
<section id="pgsql-local">
<h4>pgsql_local<a class="headerlink" href="#pgsql-local" title="Permalink to this heading">¶</a></h4>
<dl class="py function">
<dt class="sig sig-object py" id="testsuite.databases.pgsql.pytest_plugin.pgsql_local">
<span class="sig-prename descclassname"><span class="pre">testsuite.databases.pgsql.pytest_plugin.</span></span><span class="sig-name descname"><span class="pre">pgsql_local</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="../_modules/testsuite/databases/pgsql/pytest_plugin/#pgsql_local"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#testsuite.databases.pgsql.pytest_plugin.pgsql_local" title="Permalink to this definition">¶</a></dt>
<dd><p>Configures local pgsql instance.</p>
<dl class="field-list simple">
<dt class="field-odd">Returns<span class="colon">:</span></dt>
<dd class="field-odd"><p><a class="reference internal" href="#testsuite.databases.pgsql.pytest_plugin.ServiceLocalConfig" title="testsuite.databases.pgsql.pytest_plugin.ServiceLocalConfig"><code class="xref py py-class docutils literal notranslate"><span class="pre">ServiceLocalConfig</span></code></a> instance.</p>
</dd>
</dl>
<p>In order to use pgsql fixture you have to override pgsql_local()
in your local conftest.py file, example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s1">&#39;session&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">pgsql_local</span><span class="p">(</span><span class="n">pgsql_local_create</span><span class="p">):</span>
    <span class="n">databases</span> <span class="o">=</span> <span class="n">discover</span><span class="o">.</span><span class="n">find_schemas</span><span class="p">(</span>
        <span class="s1">&#39;service_name&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">PG_SCHEMAS_PATH</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">pgsql_local_create</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">databases</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
</pre></div>
</div>
<p>Sometimes it is desirable to have tests-only database, maybe used in one
particular test or tests group. This can be achieved by by overriding
<code class="docutils literal notranslate"><span class="pre">pgsql_local</span></code> fixture in your test file:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">pgsql_local</span><span class="p">(</span><span class="n">pgsql_local_create</span><span class="p">):</span>
    <span class="n">databases</span> <span class="o">=</span> <span class="n">discover</span><span class="o">.</span><span class="n">find_schemas</span><span class="p">(</span>
        <span class="s1">&#39;testsuite&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="s1">&#39;custom/pgsql/schema/path&#39;</span><span class="p">)])</span>
    <span class="k">return</span> <span class="n">pgsql_local_create</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">databases</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">pgsql_local</span></code> provides access to PostgreSQL connection parameters:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_custom_connection_string</span><span class="p">(</span><span class="n">pgsql_local</span><span class="p">):</span>
    <span class="n">conninfo</span> <span class="o">=</span> <span class="n">pgsql_local</span><span class="p">[</span><span class="s1">&#39;database_name&#39;</span><span class="p">]</span>
    <span class="n">custom_dsn</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">conninfo</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">options</span><span class="o">=</span><span class="s1">&#39;-c opt=val&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get_dsn</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">custom_dsn</span>
</pre></div>
</div>
</dd></dl>

</section>
<section id="pgsql-local-create">
<h4>pgsql_local_create<a class="headerlink" href="#pgsql-local-create" title="Permalink to this heading">¶</a></h4>
<dl class="py function">
<dt class="sig sig-object py" id="testsuite.databases.pgsql.pytest_plugin.pgsql_local_create">
<span class="sig-prename descclassname"><span class="pre">testsuite.databases.pgsql.pytest_plugin.</span></span><span class="sig-name descname"><span class="pre">pgsql_local_create</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">databases</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/testsuite/databases/pgsql/pytest_plugin/#pgsql_local_create"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#testsuite.databases.pgsql.pytest_plugin.pgsql_local_create" title="Permalink to this definition">¶</a></dt>
<dd><p>Creates pgsql configuration.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>databases</strong> – List of databases.</p>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p><a class="reference internal" href="#testsuite.databases.pgsql.pytest_plugin.ServiceLocalConfig" title="testsuite.databases.pgsql.pytest_plugin.ServiceLocalConfig"><code class="xref py py-class docutils literal notranslate"><span class="pre">ServiceLocalConfig</span></code></a> instance.</p>
</dd>
</dl>
</dd></dl>

</section>
</section>
<section id="id10">
<h3><a class="toc-backref" href="#id53" role="doc-backlink">Marks</a><a class="headerlink" href="#id10" title="Permalink to this heading">¶</a></h3>
<section id="pytest-mark-pgsql">
<h4>pytest.mark.pgsql<a class="headerlink" href="#pytest-mark-pgsql" title="Permalink to this heading">¶</a></h4>
<dl class="py function">
<dt class="sig sig-object py" id="testsuite.databases.pgsql.pytest_plugin.pytest.mark.pgsql">
<span class="sig-prename descclassname"><span class="pre">pytest.mark.</span></span><span class="sig-name descname"><span class="pre">pgsql</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">dbname</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">files</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">()</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">directories</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">()</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">queries</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">()</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#testsuite.databases.pgsql.pytest_plugin.pytest.mark.pgsql" title="Permalink to this definition">¶</a></dt>
<dd><p>Use this mark to override specify extra data fixtures in a per-test manner.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>dbname</strong> – Database name.</p></li>
<li><p><strong>files</strong> – List of filenames to apply to the database.</p></li>
<li><p><strong>directories</strong> – List of directories to apply to the database.</p></li>
<li><p><strong>directories</strong> – List of queries to apply to the database.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

</section>
</section>
<section id="id11">
<h3><a class="toc-backref" href="#id54" role="doc-backlink">Classes</a><a class="headerlink" href="#id11" title="Permalink to this heading">¶</a></h3>
<dl class="py class">
<dt class="sig sig-object py" id="testsuite.databases.pgsql.pytest_plugin.ServiceLocalConfig">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">testsuite.databases.pgsql.pytest_plugin.</span></span><span class="sig-name descname"><span class="pre">ServiceLocalConfig</span></span><a class="reference internal" href="../_modules/testsuite/databases/pgsql/pytest_plugin/#ServiceLocalConfig"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#testsuite.databases.pgsql.pytest_plugin.ServiceLocalConfig" title="Permalink to this definition">¶</a></dt>
<dd><dl class="py method">
<dt class="sig sig-object py" id="testsuite.databases.pgsql.pytest_plugin.ServiceLocalConfig.__getitem__">
<span class="sig-name descname"><span class="pre">__getitem__</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">dbname</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.11)"><span class="pre">str</span></a></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><a class="reference internal" href="#testsuite.databases.pgsql.connection.PgConnectionInfo" title="testsuite.databases.pgsql.connection.PgConnectionInfo"><span class="pre">PgConnectionInfo</span></a></span></span><a class="reference internal" href="../_modules/testsuite/databases/pgsql/pytest_plugin/#ServiceLocalConfig.__getitem__"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#testsuite.databases.pgsql.pytest_plugin.ServiceLocalConfig.__getitem__" title="Permalink to this definition">¶</a></dt>
<dd><p>Get
<a class="reference internal" href="#testsuite.databases.pgsql.connection.PgConnectionInfo" title="testsuite.databases.pgsql.connection.PgConnectionInfo"><code class="xref py py-class docutils literal notranslate"><span class="pre">testsuite.databases.pgsql.connection.PgConnectionInfo</span></code></a>
instance by database name</p>
</dd></dl>

</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="testsuite.databases.pgsql.connection.PgConnectionInfo">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">testsuite.databases.pgsql.connection.</span></span><span class="sig-name descname"><span class="pre">PgConnectionInfo</span></span><a class="reference internal" href="../_modules/testsuite/databases/pgsql/connection/#PgConnectionInfo"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#testsuite.databases.pgsql.connection.PgConnectionInfo" title="Permalink to this definition">¶</a></dt>
<dd><p>PostgreSQL connection parameters</p>
<dl class="py method">
<dt class="sig sig-object py" id="testsuite.databases.pgsql.connection.PgConnectionInfo.get_dsn">
<span class="sig-name descname"><span class="pre">get_dsn</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.11)"><span class="pre">str</span></a></span></span><a class="reference internal" href="../_modules/testsuite/databases/pgsql/connection/#PgConnectionInfo.get_dsn"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#testsuite.databases.pgsql.connection.PgConnectionInfo.get_dsn" title="Permalink to this definition">¶</a></dt>
<dd><p>PostgreSQL connection string in DSN format</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="testsuite.databases.pgsql.connection.PgConnectionInfo.get_uri">
<span class="sig-name descname"><span class="pre">get_uri</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.11)"><span class="pre">str</span></a></span></span><a class="reference internal" href="../_modules/testsuite/databases/pgsql/connection/#PgConnectionInfo.get_uri"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#testsuite.databases.pgsql.connection.PgConnectionInfo.get_uri" title="Permalink to this definition">¶</a></dt>
<dd><p>PostgreSQL connection string in URI format</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="testsuite.databases.pgsql.connection.PgConnectionInfo.replace">
<span class="sig-name descname"><span class="pre">replace</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="o"><span class="pre">**</span></span><span class="n"><span class="pre">kwargs</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><a class="reference internal" href="#testsuite.databases.pgsql.connection.PgConnectionInfo" title="testsuite.databases.pgsql.connection.PgConnectionInfo"><span class="pre">PgConnectionInfo</span></a></span></span><a class="reference internal" href="../_modules/testsuite/databases/pgsql/connection/#PgConnectionInfo.replace"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#testsuite.databases.pgsql.connection.PgConnectionInfo.replace" title="Permalink to this definition">¶</a></dt>
<dd><p>Return a new <a class="reference internal" href="#testsuite.databases.pgsql.connection.PgConnectionInfo" title="testsuite.databases.pgsql.connection.PgConnectionInfo"><code class="xref py py-class docutils literal notranslate"><span class="pre">PgConnectionInfo</span></code></a> value replacing specified
fields with new values</p>
</dd></dl>

</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="testsuite.databases.pgsql.control.PgDatabaseWrapper">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">testsuite.databases.pgsql.control.</span></span><span class="sig-name descname"><span class="pre">PgDatabaseWrapper</span></span><a class="reference internal" href="../_modules/testsuite/databases/pgsql/control/#PgDatabaseWrapper"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#testsuite.databases.pgsql.control.PgDatabaseWrapper" title="Permalink to this definition">¶</a></dt>
<dd><dl class="py property">
<dt class="sig sig-object py" id="testsuite.databases.pgsql.control.PgDatabaseWrapper.conn">
<em class="property"><span class="pre">property</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">conn</span></span><em class="property"><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="pre">connection</span></em><a class="headerlink" href="#testsuite.databases.pgsql.control.PgDatabaseWrapper.conn" title="Permalink to this definition">¶</a></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Returns<span class="colon">:</span></dt>
<dd class="field-odd"><p><code class="xref py py-class docutils literal notranslate"><span class="pre">psycopg2.extensions.connection</span></code></p>
</dd>
</dl>
</dd></dl>

<dl class="py property">
<dt class="sig sig-object py" id="testsuite.databases.pgsql.control.PgDatabaseWrapper.conninfo">
<em class="property"><span class="pre">property</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">conninfo</span></span><em class="property"><span class="p"><span class="pre">:</span></span><span class="w"> </span><a class="reference internal" href="#testsuite.databases.pgsql.connection.PgConnectionInfo" title="testsuite.databases.pgsql.connection.PgConnectionInfo"><span class="pre">PgConnectionInfo</span></a></em><a class="headerlink" href="#testsuite.databases.pgsql.control.PgDatabaseWrapper.conninfo" title="Permalink to this definition">¶</a></dt>
<dd><p>returns
<a class="reference internal" href="#testsuite.databases.pgsql.connection.PgConnectionInfo" title="testsuite.databases.pgsql.connection.PgConnectionInfo"><code class="xref py py-class docutils literal notranslate"><span class="pre">testsuite.databases.pgsql.connection.PgConnectionInfo</span></code></a></p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="testsuite.databases.pgsql.control.PgDatabaseWrapper.cursor">
<span class="sig-name descname"><span class="pre">cursor</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="o"><span class="pre">**</span></span><span class="n"><span class="pre">kwargs</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">cursor</span></span></span><a class="reference internal" href="../_modules/testsuite/databases/pgsql/control/#PgDatabaseWrapper.cursor"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#testsuite.databases.pgsql.control.PgDatabaseWrapper.cursor" title="Permalink to this definition">¶</a></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Returns<span class="colon">:</span></dt>
<dd class="field-odd"><p><code class="xref py py-class docutils literal notranslate"><span class="pre">psycopg2.extensions.cursor</span></code></p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="testsuite.databases.pgsql.control.PgDatabaseWrapper.dict_cursor">
<span class="sig-name descname"><span class="pre">dict_cursor</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="o"><span class="pre">**</span></span><span class="n"><span class="pre">kwargs</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">cursor</span></span></span><a class="reference internal" href="../_modules/testsuite/databases/pgsql/control/#PgDatabaseWrapper.dict_cursor"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#testsuite.databases.pgsql.control.PgDatabaseWrapper.dict_cursor" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns dictionary cursor, see psycopg2.extras.DictCursor</p>
<dl class="field-list simple">
<dt class="field-odd">Returns<span class="colon">:</span></dt>
<dd class="field-odd"><p><code class="xref py py-class docutils literal notranslate"><span class="pre">psycopg2.extensions.cursor</span></code></p>
</dd>
</dl>
</dd></dl>

</dd></dl>

</section>
</section>
<section id="mysql">
<h2><a class="toc-backref" href="#id55" role="doc-backlink">MySQL</a><a class="headerlink" href="#mysql" title="Permalink to this heading">¶</a></h2>
<p>In order to enable mysql support you have to add
<code class="docutils literal notranslate"><span class="pre">testsuite.databases.mysql.pytest_plugin</span></code> to <code class="docutils literal notranslate"><span class="pre">pytest_plugins</span></code> list in your
<code class="docutils literal notranslate"><span class="pre">conftest.py</span></code> file and configure MySQL schemas location.</p>
<p>By default testsuite starts <a class="reference external" href="https://dev.mysql.com/">MySQL</a> service. In this case MySQL installation
is required (MariaDB 10+ should work as well).</p>
<p>Currently mysql plugin uses synchronous <a class="reference external" href="https://github.com/PyMySQL/PyMySQL">pymysql</a> driver.</p>
<p>MySQL plugin creates database schema once. And then populates database
with data fixtures on each test. It looks for database fixtures by the
following names:</p>
<ul class="simple">
<li><p>file <code class="docutils literal notranslate"><span class="pre">my_DBNAME.sql</span></code></p></li>
<li><p>directory <code class="docutils literal notranslate"><span class="pre">my_DBNAME/</span></code></p></li>
</ul>
<section id="id12">
<h3><a class="toc-backref" href="#id56" role="doc-backlink">Customize port</a><a class="headerlink" href="#id12" title="Permalink to this heading">¶</a></h3>
<p>Testsuite may start MySQL with custom port, if <code class="docutils literal notranslate"><span class="pre">TESTSUITE_MYSQL_PORT</span></code>
environment variable is specified</p>
</section>
<section id="id13">
<h3><a class="toc-backref" href="#id57" role="doc-backlink">Use external instance</a><a class="headerlink" href="#id13" title="Permalink to this heading">¶</a></h3>
<p>You can force it to use your own mysql installation with command-line option
<code class="docutils literal notranslate"><span class="pre">--mysql=mysql://user:password&#64;hostname/</span></code>.</p>
</section>
<section id="id14">
<h3><a class="toc-backref" href="#id58" role="doc-backlink">Example integration</a><a class="headerlink" href="#id14" title="Permalink to this heading">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">testsuite.databases.mysql</span> <span class="kn">import</span> <span class="n">discover</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s1">&#39;session&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">mysql_local</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">discover</span><span class="o">.</span><span class="n">find_schemas</span><span class="p">([</span><span class="n">SCHEMAS_DIR</span><span class="p">])</span>
</pre></div>
</div>
</section>
<section id="id15">
<h3><a class="toc-backref" href="#id59" role="doc-backlink">Database access example</a><a class="headerlink" href="#id15" title="Permalink to this heading">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_read_from_database</span><span class="p">(</span><span class="n">mysql</span><span class="p">):</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">mysql</span><span class="p">[</span><span class="s1">&#39;chat_messages&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="s1">&#39;SELECT username, text FROM messages WHERE id = </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],),</span>
    <span class="p">)</span>
    <span class="n">record</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">record</span> <span class="o">==</span> <span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="id17">
<h3><a class="toc-backref" href="#id60" role="doc-backlink">Functions</a><a class="headerlink" href="#id17" title="Permalink to this heading">¶</a></h3>
<section id="id18">
<h4>find_schemas<a class="headerlink" href="#id18" title="Permalink to this heading">¶</a></h4>
<dl class="py function">
<dt class="sig sig-object py" id="testsuite.databases.mysql.discover.find_schemas">
<span class="sig-prename descclassname"><span class="pre">testsuite.databases.mysql.discover.</span></span><span class="sig-name descname"><span class="pre">find_schemas</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">schema_dirs</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/typing.html#typing.List" title="(in Python v3.11)"><span class="pre">List</span></a><span class="p"><span class="pre">[</span></span><a class="reference external" href="https://docs.python.org/3/library/pathlib.html#pathlib.Path" title="(in Python v3.11)"><span class="pre">Path</span></a><span class="p"><span class="pre">]</span></span></span></em>, <em class="sig-param"><span class="n"><span class="pre">dbprefix</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.11)"><span class="pre">str</span></a></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">'testsuite-'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">extra_schema_args</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/typing.html#typing.Optional" title="(in Python v3.11)"><span class="pre">Optional</span></a><span class="p"><span class="pre">[</span></span><a class="reference external" href="https://docs.python.org/3/library/typing.html#typing.Dict" title="(in Python v3.11)"><span class="pre">Dict</span></a><span class="p"><span class="pre">[</span></span><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.11)"><span class="pre">str</span></a><span class="p"><span class="pre">,</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/typing.html#typing.Any" title="(in Python v3.11)"><span class="pre">Any</span></a><span class="p"><span class="pre">]</span></span><span class="p"><span class="pre">]</span></span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><a class="reference external" href="https://docs.python.org/3/library/typing.html#typing.Dict" title="(in Python v3.11)"><span class="pre">Dict</span></a><span class="p"><span class="pre">[</span></span><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.11)"><span class="pre">str</span></a><span class="p"><span class="pre">,</span></span><span class="w"> </span><span class="pre">DatabaseConfig</span><span class="p"><span class="pre">]</span></span></span></span><a class="reference internal" href="../_modules/testsuite/databases/mysql/discover/#find_schemas"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#testsuite.databases.mysql.discover.find_schemas" title="Permalink to this definition">¶</a></dt>
<dd><p>Retrieve database schemas from filesystem.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>schema_dirs</strong> – list of schema pathes</p></li>
<li><p><strong>dbprefix</strong> – database name internal prefix</p></li>
<li><p><strong>extra_schema_args</strong> – for each DB contains list
of tables we don’t have to truncate and flag for explicit creation</p></li>
</ul>
</dd>
</dl>
<dl>
<dt>example:</dt><dd><dl>
<dt>{</dt><dd><dl>
<dt>‘database1’: {</dt><dd><p>‘create’: False,
‘truncate_non_empty’: True,
‘keep_tables’: [</p>
<blockquote>
<div><p>‘table1’, ‘table2’</p>
</div></blockquote>
<p>]</p>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<dl class="field-list simple">
<dt class="field-odd">Returns<span class="colon">:</span></dt>
<dd class="field-odd"><p>Dictionary where key is dbname and value is
<code class="docutils literal notranslate"><span class="pre">classes.DatabaseConfig</span></code> instance.</p>
</dd>
</dl>
</dd></dl>

</section>
</section>
<section id="id19">
<h3><a class="toc-backref" href="#id61" role="doc-backlink">Fixtures</a><a class="headerlink" href="#id19" title="Permalink to this heading">¶</a></h3>
<section id="id20">
<h4>mysql<a class="headerlink" href="#id20" title="Permalink to this heading">¶</a></h4>
<dl class="py function">
<dt class="sig sig-object py">
<span class="sig-prename descclassname"><span class="pre">testsuite.databases.mysql.pytest_plugin.</span></span><span class="sig-name descname"><span class="pre">mysql</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="../_modules/testsuite/databases/mysql/pytest_plugin/#mysql"><span class="viewcode-link"><span class="pre">[source]</span></span></a></dt>
<dd><p>MySQL fixture.</p>
<p>Returns dictionary where key is database alias and value is
<code class="xref py py-class docutils literal notranslate"><span class="pre">control.ConnectionWrapper</span></code></p>
</dd></dl>

</section>
<section id="mysql-local">
<h4>mysql_local<a class="headerlink" href="#mysql-local" title="Permalink to this heading">¶</a></h4>
<dl class="py function">
<dt class="sig sig-object py">
<span class="sig-prename descclassname"><span class="pre">testsuite.databases.mysql.pytest_plugin.</span></span><span class="sig-name descname"><span class="pre">mysql_local</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="../_modules/testsuite/databases/mysql/pytest_plugin/#mysql_local"><span class="viewcode-link"><span class="pre">[source]</span></span></a></dt>
<dd><p>Use to override databases configuration.</p>
</dd></dl>

</section>
<section id="mysql-conninfo">
<h4>mysql_conninfo<a class="headerlink" href="#mysql-conninfo" title="Permalink to this heading">¶</a></h4>
<dl class="py function">
<dt class="sig sig-object py">
<span class="sig-prename descclassname"><span class="pre">testsuite.databases.mysql.pytest_plugin.</span></span><span class="sig-name descname"><span class="pre">mysql_conninfo</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="../_modules/testsuite/databases/mysql/pytest_plugin/#mysql_conninfo"><span class="viewcode-link"><span class="pre">[source]</span></span></a></dt>
<dd></dd></dl>

</section>
</section>
<section id="id21">
<h3><a class="toc-backref" href="#id62" role="doc-backlink">Marks</a><a class="headerlink" href="#id21" title="Permalink to this heading">¶</a></h3>
<section id="pytest-mark-mysql">
<h4>pytest.mark.mysql<a class="headerlink" href="#pytest-mark-mysql" title="Permalink to this heading">¶</a></h4>
<dl class="py function">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">pytest.mark.mysql(dbname,</span> <span class="pre">*,</span> <span class="pre">files=(),</span> <span class="pre">directories=(),</span> <span class="pre">queries=()):</span></span></dt>
<dd><p>Use this mark to specify extra data fixtures in a per-test manner.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>dbname</strong> – Database name.</p></li>
<li><p><strong>files</strong> – List of filenames to apply to the database.</p></li>
<li><p><strong>directories</strong> – List of directories to apply to the database.</p></li>
<li><p><strong>queries</strong> – List of queries to apply to the database.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

</section>
</section>
<section id="id22">
<h3><a class="toc-backref" href="#id63" role="doc-backlink">Classes</a><a class="headerlink" href="#id22" title="Permalink to this heading">¶</a></h3>
<dl class="py class">
<dt class="sig sig-object py">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">testsuite.databases.mysql.control.</span></span><span class="sig-name descname"><span class="pre">ConnectionWrapper</span></span><a class="reference internal" href="../_modules/testsuite/databases/mysql/control/#ConnectionWrapper"><span class="viewcode-link"><span class="pre">[source]</span></span></a></dt>
<dd><p>MySQL database connection wrapper.</p>
<dl class="py property">
<dt class="sig sig-object py">
<em class="property"><span class="pre">property</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">conninfo</span></span><em class="property"><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="pre">ConnectionInfo</span></em></dt>
<dd><p><code class="xref py py-class docutils literal notranslate"><span class="pre">classes.ConnectionInfo</span></code> instance.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">cursor</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="o"><span class="pre">**</span></span><span class="n"><span class="pre">kwargs</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">Cursor</span></span></span><a class="reference internal" href="../_modules/testsuite/databases/mysql/control/#ConnectionWrapper.cursor"><span class="viewcode-link"><span class="pre">[source]</span></span></a></dt>
<dd><p>Returns cursor instance.</p>
</dd></dl>

</dd></dl>

<dl class="py class">
<dt class="sig sig-object py">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">testsuite.databases.mysql.classes.</span></span><span class="sig-name descname"><span class="pre">ConnectionInfo</span></span><a class="reference internal" href="../_modules/testsuite/databases/mysql/classes/#ConnectionInfo"><span class="viewcode-link"><span class="pre">[source]</span></span></a></dt>
<dd><p>Mysql connection info class.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>port</strong> – database port</p></li>
<li><p><strong>hostname</strong> – database hostname</p></li>
<li><p><strong>user</strong> – database user</p></li>
<li><p><strong>password</strong> – database password</p></li>
<li><p><strong>dbname</strong> – database name</p></li>
</ul>
</dd>
</dl>
<dl class="py method">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">replace</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="o"><span class="pre">**</span></span><span class="n"><span class="pre">kwargs</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">ConnectionInfo</span></span></span><a class="reference internal" href="../_modules/testsuite/databases/mysql/classes/#ConnectionInfo.replace"><span class="viewcode-link"><span class="pre">[source]</span></span></a></dt>
<dd><p>Returns new instance with attributes updated.</p>
</dd></dl>

</dd></dl>

</section>
</section>
<section id="redis">
<h2><a class="toc-backref" href="#id64" role="doc-backlink">Redis</a><a class="headerlink" href="#redis" title="Permalink to this heading">¶</a></h2>
<p>Testsuite provides basic support for redis.</p>
<p>Testsuite may start redis with custom ports, if following environment variables
are specified:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">TESTSUITE_REDIS_MASTER_PORTS</span></code> - if set, must be two comma separated
integers</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">TESTSUITE_REDIS_SENTINEL_PORT</span></code> - if set, must be integer</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">TESTSUITE_REDIS_SLAVE_PORTS</span></code> - if set must be three comma separated
integers</p></li>
</ul>
</section>
<section id="clickhouse">
<h2><a class="toc-backref" href="#id65" role="doc-backlink">ClickHouse</a><a class="headerlink" href="#clickhouse" title="Permalink to this heading">¶</a></h2>
<p>In order to enable clickhouse support you have to add
<code class="docutils literal notranslate"><span class="pre">testsuite.databases.clickhouse.pytest_plugin</span></code> to <code class="docutils literal notranslate"><span class="pre">pytest_plugins</span></code> list in your
<code class="docutils literal notranslate"><span class="pre">conftest.py</span></code> file and configure ClickHouse schemas location.</p>
<p>By default testsuite starts <a class="reference external" href="https://clickhouse.com/">ClickHouse</a> service. In this case ClickHouse installation
is required.</p>
<p>Currently clickhouse plugin uses synchronous <a class="reference external" href="https://github.com/mymarilyn/clickhouse-driver">clickhouse-driver</a> driver.</p>
<p>ClickHouse plugin creates database schema once. And then populates database
with data fixtures on each test. It looks for database fixtures by the
following names:</p>
<ul class="simple">
<li><p>file <code class="docutils literal notranslate"><span class="pre">ch_DBNAME.sql</span></code></p></li>
<li><p>directory <code class="docutils literal notranslate"><span class="pre">ch_DBNAME/</span></code></p></li>
</ul>
<section id="clickhouse-installation">
<h3><a class="toc-backref" href="#id66" role="doc-backlink">ClickHouse installation</a><a class="headerlink" href="#clickhouse-installation" title="Permalink to this heading">¶</a></h3>
<p>For debian please run these commands:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo<span class="w"> </span>apt<span class="w"> </span>update<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>clickhouse-common-static
</pre></div>
</div>
<p>(<a class="reference external" href="https://clickhouse.com/docs/en/getting-started/install/#packages">https://clickhouse.com/docs/en/getting-started/install/#packages</a>),</p>
<p>For macos follow instructions at <a class="reference external" href="https://clickhouse.com/docs/en/getting-started/install/#from-binaries-non-linux">https://clickhouse.com/docs/en/getting-started/install/#from-binaries-non-linux</a></p>
<p>If you already have clickhouse installed, please symlink it to <code class="docutils literal notranslate"><span class="pre">/usr/bin/clickhouse</span></code></p>
</section>
<section id="customize-ports">
<h3><a class="toc-backref" href="#id67" role="doc-backlink">Customize ports</a><a class="headerlink" href="#customize-ports" title="Permalink to this heading">¶</a></h3>
<p>Testsuite may start ClickHouse with custom ports, if
<code class="docutils literal notranslate"><span class="pre">TESTSUITE_CLICKHOUSE_SERVER_TCP_PORT</span></code> or <code class="docutils literal notranslate"><span class="pre">TESTSUITE_CLICKHOUSE_SERVER_HTTP_PORT</span></code>
environment variables are specified.</p>
</section>
<section id="id23">
<h3><a class="toc-backref" href="#id68" role="doc-backlink">Use external instance</a><a class="headerlink" href="#id23" title="Permalink to this heading">¶</a></h3>
<p>Usage of external installation is not supported for now.</p>
</section>
<section id="id24">
<h3><a class="toc-backref" href="#id69" role="doc-backlink">Example integration</a><a class="headerlink" href="#id24" title="Permalink to this heading">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">testsuite.databases.clickhouse</span> <span class="kn">import</span> <span class="n">discover</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s1">&#39;session&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">clickhouse_local</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">discover</span><span class="o">.</span><span class="n">find_schemas</span><span class="p">([</span><span class="n">SCHEMAS_DIR</span><span class="p">])</span>
</pre></div>
</div>
</section>
<section id="id25">
<h3><a class="toc-backref" href="#id70" role="doc-backlink">Database access example</a><a class="headerlink" href="#id25" title="Permalink to this heading">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_read_from_database</span><span class="p">(</span><span class="n">clickhouse</span><span class="p">):</span>
    <span class="n">connection</span> <span class="o">=</span> <span class="n">clickhouse</span><span class="p">[</span><span class="s1">&#39;chat_messages&#39;</span><span class="p">]</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SELECT * FROM system.numbers LIMIT 5&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,),</span> <span class="p">(</span><span class="mi">4</span><span class="p">,)]</span>
</pre></div>
</div>
</section>
<section id="id27">
<h3><a class="toc-backref" href="#id71" role="doc-backlink">Functions</a><a class="headerlink" href="#id27" title="Permalink to this heading">¶</a></h3>
<section id="id28">
<h4>find_schemas<a class="headerlink" href="#id28" title="Permalink to this heading">¶</a></h4>
<dl class="py function">
<dt class="sig sig-object py" id="testsuite.databases.clickhouse.discover.find_schemas">
<span class="sig-prename descclassname"><span class="pre">testsuite.databases.clickhouse.discover.</span></span><span class="sig-name descname"><span class="pre">find_schemas</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">schema_dirs</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/typing.html#typing.List" title="(in Python v3.11)"><span class="pre">List</span></a><span class="p"><span class="pre">[</span></span><a class="reference external" href="https://docs.python.org/3/library/pathlib.html#pathlib.Path" title="(in Python v3.11)"><span class="pre">Path</span></a><span class="p"><span class="pre">]</span></span></span></em>, <em class="sig-param"><span class="n"><span class="pre">dbprefix</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.11)"><span class="pre">str</span></a></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">'testsuite-'</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><a class="reference external" href="https://docs.python.org/3/library/typing.html#typing.Dict" title="(in Python v3.11)"><span class="pre">Dict</span></a><span class="p"><span class="pre">[</span></span><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.11)"><span class="pre">str</span></a><span class="p"><span class="pre">,</span></span><span class="w"> </span><span class="pre">DatabaseConfig</span><span class="p"><span class="pre">]</span></span></span></span><a class="reference internal" href="../_modules/testsuite/databases/clickhouse/discover/#find_schemas"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#testsuite.databases.clickhouse.discover.find_schemas" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

</section>
</section>
<section id="id29">
<h3><a class="toc-backref" href="#id72" role="doc-backlink">Fixtures</a><a class="headerlink" href="#id29" title="Permalink to this heading">¶</a></h3>
<section id="id30">
<h4>clickhouse<a class="headerlink" href="#id30" title="Permalink to this heading">¶</a></h4>
<dl class="py function">
<dt class="sig sig-object py">
<span class="sig-prename descclassname"><span class="pre">testsuite.databases.clickhouse.pytest_plugin.</span></span><span class="sig-name descname"><span class="pre">clickhouse</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="../_modules/testsuite/databases/clickhouse/pytest_plugin/#clickhouse"><span class="viewcode-link"><span class="pre">[source]</span></span></a></dt>
<dd></dd></dl>

</section>
<section id="clickhouse-local">
<h4>clickhouse_local<a class="headerlink" href="#clickhouse-local" title="Permalink to this heading">¶</a></h4>
<dl class="py function">
<dt class="sig sig-object py">
<span class="sig-prename descclassname"><span class="pre">testsuite.databases.clickhouse.pytest_plugin.</span></span><span class="sig-name descname"><span class="pre">clickhouse_local</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="../_modules/testsuite/databases/clickhouse/pytest_plugin/#clickhouse_local"><span class="viewcode-link"><span class="pre">[source]</span></span></a></dt>
<dd><p>Use to override databases configuration.</p>
</dd></dl>

</section>
<section id="clickhouse-conn-info">
<h4>clickhouse_conn_info<a class="headerlink" href="#clickhouse-conn-info" title="Permalink to this heading">¶</a></h4>
<dl class="py function">
<dt class="sig sig-object py">
<span class="sig-prename descclassname"><span class="pre">testsuite.databases.clickhouse.pytest_plugin.</span></span><span class="sig-name descname"><span class="pre">clickhouse_conn_info</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="../_modules/testsuite/databases/clickhouse/pytest_plugin/#clickhouse_conn_info"><span class="viewcode-link"><span class="pre">[source]</span></span></a></dt>
<dd></dd></dl>

</section>
</section>
<section id="id31">
<h3><a class="toc-backref" href="#id73" role="doc-backlink">Marks</a><a class="headerlink" href="#id31" title="Permalink to this heading">¶</a></h3>
<section id="pytest-mark-clickhouse">
<h4>pytest.mark.clickhouse<a class="headerlink" href="#pytest-mark-clickhouse" title="Permalink to this heading">¶</a></h4>
<dl class="py function">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">pytest.mark.clickhouse(dbname,</span> <span class="pre">*,</span> <span class="pre">files=(),</span> <span class="pre">directories=(),</span> <span class="pre">queries=()):</span></span></dt>
<dd><p>Use this mark to specify extra data fixtures in a per-test manner.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>dbname</strong> – Database name.</p></li>
<li><p><strong>files</strong> – List of filenames to apply to the database.</p></li>
<li><p><strong>directories</strong> – List of directories to apply to the database.</p></li>
<li><p><strong>queries</strong> – List of queries to apply to the database.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

</section>
</section>
<section id="id32">
<h3><a class="toc-backref" href="#id74" role="doc-backlink">Classes</a><a class="headerlink" href="#id32" title="Permalink to this heading">¶</a></h3>
<dl class="py class">
<dt class="sig sig-object py">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">testsuite.databases.clickhouse.classes.</span></span><span class="sig-name descname"><span class="pre">ConnectionInfo</span></span><a class="reference internal" href="../_modules/testsuite/databases/clickhouse/classes/#ConnectionInfo"><span class="viewcode-link"><span class="pre">[source]</span></span></a></dt>
<dd><p>Clickhouse connection parameters</p>
</dd></dl>

</section>
</section>
<section id="rabbitmq">
<h2><a class="toc-backref" href="#id75" role="doc-backlink">RabbitMQ</a><a class="headerlink" href="#rabbitmq" title="Permalink to this heading">¶</a></h2>
<p>In order to enable RabbitMQ support you have to add
<code class="docutils literal notranslate"><span class="pre">testsuite.rabbitmq.pytest_plugin</span></code> to <code class="docutils literal notranslate"><span class="pre">pytest_plugins</span></code> list in your
<code class="docutils literal notranslate"><span class="pre">conftest.py</span></code>.</p>
<p>By default testsuite starts <a class="reference external" href="https://www.rabbitmq.com/">RabbitMQ</a> service. In this case RabbitMQ installation
is required.</p>
<p>Currently RabbitMQ plugin uses async <a class="reference external" href="https://github.com/mosquito/aio-pika">aio-pika</a> driver.</p>
<section id="rabbitmq-installation">
<h3><a class="toc-backref" href="#id76" role="doc-backlink">RabbitMQ installation</a><a class="headerlink" href="#rabbitmq-installation" title="Permalink to this heading">¶</a></h3>
<p>Consult official docs at <a class="reference external" href="https://www.rabbitmq.com/download.html">https://www.rabbitmq.com/download.html</a></p>
<p>If you already have RabbitMQ installed and its location differs from
<cite>/usr/lib/rabbitmq</cite> please specify
<code class="docutils literal notranslate"><span class="pre">TESTSUITE_RABBITMQ_BINDIR</span></code> environment variable accordingly.</p>
</section>
<section id="id33">
<h3><a class="toc-backref" href="#id77" role="doc-backlink">Customize ports</a><a class="headerlink" href="#id33" title="Permalink to this heading">¶</a></h3>
<p>Testsuite may start RabbitMQ with custom ports if
<code class="docutils literal notranslate"><span class="pre">TESTSUITE_RABBITMQ_TCP_PORT</span></code> or <code class="docutils literal notranslate"><span class="pre">TESTSUITE_RABBITMQ_EPMD_PORT</span></code>
environment variables are specified.</p>
</section>
<section id="id34">
<h3><a class="toc-backref" href="#id78" role="doc-backlink">Use external instance</a><a class="headerlink" href="#id34" title="Permalink to this heading">¶</a></h3>
<p>Usage of external instance is not officially supported for now,
but if your instance is local you may try setting environment variable
<code class="docutils literal notranslate"><span class="pre">TESTSUITE_RABBITMQ_TCP_PORT</span></code> and pytest option <code class="docutils literal notranslate"><span class="pre">--rabbitmq=1</span></code>
and see if it works.</p>
</section>
<section id="usage-example">
<h3><a class="toc-backref" href="#id79" role="doc-backlink">Usage example</a><a class="headerlink" href="#usage-example" title="Permalink to this heading">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">async</span> <span class="k">def</span> <span class="nf">test_rabbitmq_basic</span><span class="p">(</span><span class="n">rabbitmq</span><span class="p">):</span>
    <span class="n">exchange</span> <span class="o">=</span> <span class="s1">&#39;testsuite_exchange&#39;</span>
    <span class="n">queue</span> <span class="o">=</span> <span class="s1">&#39;testsuite_queue&#39;</span>
    <span class="n">routing_key</span> <span class="o">=</span> <span class="s1">&#39;testsuite_routing_key&#39;</span>

    <span class="n">channel</span> <span class="o">=</span> <span class="k">await</span> <span class="n">rabbitmq</span><span class="o">.</span><span class="n">get_channel</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">with</span> <span class="n">channel</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">channel</span><span class="o">.</span><span class="n">declare_exchange</span><span class="p">(</span>
            <span class="n">exchange</span><span class="o">=</span><span class="n">exchange</span><span class="p">,</span> <span class="n">exchange_type</span><span class="o">=</span><span class="s1">&#39;fanout&#39;</span>
        <span class="p">)</span>
        <span class="k">await</span> <span class="n">channel</span><span class="o">.</span><span class="n">declare_queue</span><span class="p">(</span><span class="n">queue</span><span class="o">=</span><span class="n">queue</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">channel</span><span class="o">.</span><span class="n">bind_queue</span><span class="p">(</span>
            <span class="n">queue</span><span class="o">=</span><span class="n">queue</span><span class="p">,</span> <span class="n">exchange</span><span class="o">=</span><span class="n">exchange</span><span class="p">,</span> <span class="n">routing_key</span><span class="o">=</span><span class="n">routing_key</span>
        <span class="p">)</span>
        <span class="k">await</span> <span class="n">channel</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span>
            <span class="n">exchange</span><span class="o">=</span><span class="n">exchange</span><span class="p">,</span>
            <span class="n">routing_key</span><span class="o">=</span><span class="n">routing_key</span><span class="p">,</span>
            <span class="n">body</span><span class="o">=</span><span class="sa">b</span><span class="s1">&#39;hi from testsuite!&#39;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">messages</span> <span class="o">=</span> <span class="k">await</span> <span class="n">channel</span><span class="o">.</span><span class="n">consume</span><span class="p">(</span><span class="n">queue</span><span class="o">=</span><span class="n">queue</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">messages</span> <span class="o">==</span> <span class="p">[</span><span class="sa">b</span><span class="s1">&#39;hi from testsuite!&#39;</span><span class="p">]</span>
</pre></div>
</div>
</section>
<section id="id36">
<h3><a class="toc-backref" href="#id80" role="doc-backlink">Fixtures</a><a class="headerlink" href="#id36" title="Permalink to this heading">¶</a></h3>
<section id="id37">
<h4>rabbitmq<a class="headerlink" href="#id37" title="Permalink to this heading">¶</a></h4>
<dl class="py function">
<dt class="sig sig-object py">
<span class="sig-prename descclassname"><span class="pre">testsuite.databases.rabbitmq.pytest_plugin.</span></span><span class="sig-name descname"><span class="pre">rabbitmq</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="../_modules/testsuite/databases/rabbitmq/pytest_plugin/#rabbitmq"><span class="viewcode-link"><span class="pre">[source]</span></span></a></dt>
<dd></dd></dl>

</section>
</section>
<section id="id38">
<h3><a class="toc-backref" href="#id81" role="doc-backlink">Classes</a><a class="headerlink" href="#id38" title="Permalink to this heading">¶</a></h3>
<dl class="py class">
<dt class="sig sig-object py">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">testsuite.databases.rabbitmq.classes.</span></span><span class="sig-name descname"><span class="pre">ConnectionInfo</span></span><a class="reference internal" href="../_modules/testsuite/databases/rabbitmq/classes/#ConnectionInfo"><span class="viewcode-link"><span class="pre">[source]</span></span></a></dt>
<dd><p>RabbitMQ connection parameters</p>
</dd></dl>

</section>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../">
    <img class="logo" src="../_static/logo.png" alt="Logo"/>
    
  </a>
</p>








<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../intro/">Overview</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../reference/">API reference</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../staticfiles/">Working with static files</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mockserver/">Http mockserver</a></li>
<li class="toctree-l2"><a class="reference internal" href="../servicerunner/">Spawning and accessing service</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testpoint/">Testpoint</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Database support</a></li>
<li class="toctree-l2"><a class="reference internal" href="../other_plugins/">Other plugins</a></li>
<li class="toctree-l2"><a class="reference internal" href="../utils/">Utils</a></li>
<li class="toctree-l2"><a class="reference internal" href="../utils/#matching">Matching</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tcp_mockserver/">Tcp mockserver</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../examples/README/">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../license/">License</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../">Documentation overview</a><ul>
  <li><a href="../reference/">API reference</a><ul>
      <li>Previous: <a href="../testpoint/" title="previous chapter">Testpoint</a></li>
      <li>Next: <a href="../other_plugins/" title="next chapter">Other plugins</a></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search/" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2020-2023, Yandex LLC.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 5.3.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../_sources/databases.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>